---
layout:     post
title:    "Verilog实现有符号定点数运算"
subtitle:   ""
date:     2022-06-01 14:06:24.000000000 +09:00
author:     "傅泽薪"
header-img: "img/home-bg.jpg"
tags:
- 数字设计
---

### 背景

Verilog没有官方支持定点数，但可以借用整数来实现定点数的运算。也就是说，我们设定的定点数有几位小数只有我们自己知道，而Verilog是按整数的方式来计算的。借助一些微调，就能达到Verilog计算定点数的效果。

### 有符号定点数乘法和加法

我们先回顾一下有符号定点数的运算规则，再依此来讨论如何借Verilog的wire和reg变量实现定点数运算。

假设有两个定点数Q4.2 Q3.4，他们各有一位符号位。

做加法时，将二者小数点对齐，把Q4.2变成Q4.4，然后按整数加法计算。结果为Q5.4（进一位），带一位符号位。

做乘法时，按整数方法计算。结果为Q7.6，带两位符号位。

因此，如果我们两个运算数的小数位相同，无论做加法和乘法，都只需要按整数方法计算，无需做调整。

### Verilog的signed变量

Verilog支持有符号变量及其运算，前提是声明变量时加入signed字符，或运算时在变量或数字前加入$signed()字符。

要注意的是，在Verilog运算中，如果左右两边出现一个以上的unsigned变量，整个运算都会按unsigned处理。所以要保证两边都为signed变量或使用$signed()。

### 截断与饱和溢出

由于每次乘法后结果的位宽会翻倍，每次加法后结果的位宽会+1，在定点数运算中经常需要把某个变量截断成低位宽。而当截断后的位宽不足以表示变量值，就需要做饱和溢出的处理。如何判断需要饱和溢出呢？我们根据符号位来判断：如果多出的符号位全为1或全为0，那么无需饱和溢出，直接截断；否则根据最高位向下或向上饱和溢出。具体代码如下：

![image-20220530155908310](https://tuchuang-1254351169.cos.ap-guangzhou.myqcloud.com/image-20220530155908310.png)